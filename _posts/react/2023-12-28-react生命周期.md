---
title: react生命周期
date: 2023-12-28 20:15:00 +0800
categories: [react]
tags: [react]
description: react生命周期
---

## 生命周期
在 React 中，组件的生命周期函数可以帮助我们管理组件在不同阶段的行为。React 16.3 之前的版本和 React 16.3 之后有所不同。以下是 React 组件生命周期函数的详细列表：

### 旧的生命周期（React 16.3 之前）

1. **`componentWillMount()`**
    - 在组件即将被挂载到 DOM 之前立刻调用。

2. **`componentDidMount()`**
    - 组件已经被挂载到 DOM 后立刻调用。

3. **`componentWillReceiveProps(nextProps)`**
    - 在组件接收到新的 props 之前立刻调用。此方法在初始化渲染时不会被调用。

4. **`shouldComponentUpdate(nextProps, nextState)`**
    - 在组件接收到新的 props 或 state 时，判断组件是否需要重新渲染。默认返回 `true`，除非你有特定的优化需要。

5. **`componentWillUpdate(nextProps, nextState`)**
    - 在组件开始重新渲染之前立刻调用。

6. **`componentDidUpdate(prevProps, prevState)`**
    - 组件重新渲染并将更改应用到 DOM 后立刻调用。

7. **`componentWillUnmount()`**
    - 在组件被卸载和销毁之前立刻调用。通常在此方法中执行一些清理工作。

8. **`componentDidCatch(error, info)`**
    - 在子组件抛出错误后被调用。仅在开发模式下以及在生产模式下使用 React 16 时才会被触发。

### 新的生命周期（React 16.3 之后）

从 React 16.3 开始，旧的生命周期方法已被标记为不推荐使用，并被官方废弃。而新的生命周期主要围绕三个主要阶段：

1. **挂载`（Mounting）`**
    - **`constructor()`**
    - **`static getDerivedStateFromProps(props, state)`**
    - **`render()`**
    - **`componentDidMount()`**

2. **更新`（Updating）`**
    - **`static getDerivedStateFromProps(props, state)`**
    - **`shouldComponentUpdate(nextProps, nextState)`**
    - **`render()`**
    - **`getSnapshotBeforeUpdate(prevProps, prevState)`**
    - **`componentDidUpdate(prevProps, prevState, snapshot)`**

3. **卸载`（Unmounting）`**
    - **`componentWillUnmount()`**

4. **错误处理`（Error Handling）`**
    - **`static getDerivedStateFromError(error)`**
    - **`componentDidCatch(error, info)`**

这是 React 组件生命周期函数的概览。随着 React 的版本迭代，某些生命周期函数可能会被更改或添加，因此建议查阅官方文档以获取最新信息。


## `setState` 同步还是异步
- 同步表现有：自定义的 DOM 事件， setState 是同步的；异步setTimeout中 setState同步
- 直接使用 setState 是异步表现

### `setState` 所谓同步还是异步原理
- `setState` 无所谓异步还是同步
- 看是否命中 `batchUpdate` 机制
- 判断 `isBatchingUpdates`

#### 哪些能命中 `batchUpdate` 机制
- 生命周期（和它调用的函数）
- React 中注册的事件（和它调用的函数）
- React 可以”管理“的入口

#### 哪些不能命中 `batchUpdate` 机制
- `setTimeout` `setInterval`等（和它调用的函数）
- 自定义的 `DOM` 事件（和它调用的函数）
- `React` "管不到”的入口

![Alt text](/react/img/image.png)


> 总结：`setState` 同步与异步的体现主要在于是否命中 `batchUpdate`机制，在 React入口注册的方法都将会命中 `batchUpdate` 机制。非 React 入口的函数或者自定义事件，都不会命中 `batchUpdate`机制. 结论：如果 `setState` 是在`batchUpdate`机制中那么就是异步执行，否则就是同步执行



## 事件event
evnet打印出的并非是对应事件的DOM
- `event` 是 `SyntheticEvent`，模拟出来的 DOM 事件所有能力
- `event.nativeEvent` 是原生事件对象
- 所有的事件都被挂载到 `document` 上
    - `react16`事件是绑定到  `document`
    - `react17`事件绑定到 `root`组件（有利于多个React版本并存，例如微前端）
- 和 dom 事件不一样，与vue事件也不一样（vue是直接挂载到对应事件的dom上）

### `SyntheticEvent`为何要用‘合成事件机制’
- 更好的兼容性和跨平台
- 转载到 `root/document` 上，减少内存消耗，避免频繁解绑
- 方便事件的统一管理（如事务机制）


## Portals
使用场景：
- overflow:hidden(BFC)
- 父组件 z-index 值太小
- fixed 需要放到 body 第一层

使用代码示例：
```react
import React from 'react'
import ReactDOM from 'react-dom'

class App extends React.Component {
    constructor(props) {
        super(props)
        this.state = {

        }
    }

    render() {
        return ReactDOM.createPortal(
            <div>{this.props.children}</div>,
            document.body   // 要渲染的节点
        )
    }
}

```


